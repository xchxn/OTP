<div class="searchFormContainer">
  <div class="filterFormContainer">
    <!-- 오브젝트 필터 -->
    <form class="objektFilterForm" [formGroup]="objektFilterForm" (ngSubmit)="getThumbnail()">
      <mat-form-field appearance="outline">
        <mat-label>Season</mat-label>
        <mat-select formControlName="season">
          @for (season of objektFilter.season; track season) {
          <mat-option [value]="season">{{season}}</mat-option>
          }
        </mat-select>
      </mat-form-field>
      <mat-form-field appearance="outline">
        <mat-label>Member</mat-label>
        <mat-select formControlName="member">
          @for (member of objektFilter.member; track member) {
          <mat-option [value]="member">{{member}}</mat-option>
          }
        </mat-select>
      </mat-form-field>
      <mat-form-field appearance="outline">
        <mat-label>Classes</mat-label>
        <mat-select formControlName="classes">
          @for (classes of objektFilter.classes; track classes) {
          <mat-option [value]="classes">{{classes}}</mat-option>
          }
        </mat-select>
      </mat-form-field>
      <mat-form-field appearance="outline">
        <mat-label>Collection No</mat-label>
        <mat-select formControlName="collectionNo">
          @for (collectionNo of objektFilter.collectionNo; track collectionNo) {
          <mat-option [value]="collectionNo">{{collectionNo}}</mat-option>
          }
        </mat-select>
      </mat-form-field>
      <div class="button-group">
        <button type="button" class="secondary" (click)="addObjektToHaveArray()" aria-label="Find Have items">Have 찾기</button>
        <button type="button" class="primary" (click)="addObjektToWantArray()" aria-label="Find Want items">Want 찾기</button>
      </div>
    </form>
  </div>

  <!-- 필터로 검색해서 찾기 -->
  <div class="objektArrayContainer">
    <form class="objektArrayForm" [formGroup]="searchForm" (ngSubmit)="searchObjekt()">
      <div class="searchObjektArray" *ngIf="searchForm.get('objekt.have')?.value.length > 0">
        <h3 class="array-title">Have</h3>
        <div class="objekt-grid">
          <div class="objekt-container" *ngFor="let haveItem of searchForm.get('objekt.have')?.value; let i = index">
            <img [src]="haveItem.thumbnailImage" [alt]="'Collection ' + haveItem.collectionId"
              class="objekt-img" [matTooltip]="haveItem.collectionId">
          </div>
        </div>
      </div>
      <div class="searchObjektArray" *ngIf="searchForm.get('objekt.want')?.value.length > 0">
        <h3 class="array-title">Want</h3>
        <div class="objekt-grid">
          <div class="objekt-container" *ngFor="let wantItem of searchForm.get('objekt.want')?.value; let i = index">
            <img [src]="wantItem.thumbnailImage" [alt]="'Collection ' + wantItem.collectionId"
              class="objekt-img" [matTooltip]="wantItem.collectionId">
          </div>
        </div>
      </div>
      <div class="button-group end">
        <button type="button" class="secondary" (click)="resetOptions()" aria-label="Reset search">Reset</button>
        <button type="submit" class="primary" aria-label="Search Objekt">Search Objekt</button>
      </div>
    </form>
  </div>
</div>

<div class="button-group end action-buttons">
  <button type="button" class="secondary" (click)="getMyPost()" aria-label="View my posts">
    My Post
  </button>
  <button type="button" class="secondary" (click)="searchWithPosting()" aria-label="Search matching posts">
    Search Matching for post
  </button>
  <button class="primary" routerLink="/post" routerLinkActive="active" ariaCurrentWhenActive="page" aria-label="Create new post">
    Post
  </button>
</div>

<!-- 포스팅 목록 -->
@for (posting of postings; track posting.posting_id) {
<div class="postingCards">
  <div class="postingCardTitle">
    <ng-container *ngIf="updateMode && userId === posting.posting_userId; else viewTitle">
      <mat-form-field appearance="outline" class="title-input">
        <mat-label>Title</mat-label>
        <input matInput [(ngModel)]="posting.posting_title" placeholder="Enter title" />
      </mat-form-field>
    </ng-container>
    <ng-template #viewTitle>
      <h2>{{ posting.posting_title }}</h2>
    </ng-template>
  </div>
  
  <div class="postingOption">
    <div class="user-actions">
      <button mat-button [matMenuTriggerFor]="menu" class="username-button">
        {{ posting.posting_username }}
      </button>
      <mat-menu #menu="matMenu">
        <button mat-menu-item (click)="goDM(posting.posting_userId, posting.posting_username)">
          <mat-icon>chat</mat-icon>
          <span>DM</span>
        </button>
        <button mat-menu-item>
          <mat-icon>close</mat-icon>
          <span>Close</span>
        </button>
      </mat-menu>
    </div>
    
    <div class="post-actions" *ngIf="userId === posting.posting_userId">
      <button mat-icon-button [matMenuTriggerFor]="postingOption" aria-label="Post options">
        <mat-icon>more_vert</mat-icon>
      </button>
      <mat-menu #postingOption="matMenu">
        <button mat-menu-item (click)="changeUpdateMode()">
          <mat-icon>edit</mat-icon>
          <span>Update</span>
        </button>
        <button mat-menu-item (click)="deletePosting(posting)">
          <mat-icon>delete</mat-icon>
          <span>Delete</span>
        </button>
      </mat-menu>
    </div>
  </div>
  
  <div class="postingCardContent">
    <ng-container *ngIf="updateMode && userId === posting.posting_userId; else viewContent">
      <mat-form-field appearance="outline" class="content-input">
        <mat-label>Content</mat-label>
        <textarea matInput [(ngModel)]="posting.posting_content" placeholder="Enter content"></textarea>
      </mat-form-field>
    </ng-container>
    <ng-template #viewContent>
      <p>{{ posting.posting_content }}</p>
    </ng-template>
  </div>
  <div class="objektArray">
    <p>Have</p>
    <div class="objekt-container" *ngFor="let thumb of posting?.thumbnails?.have">
      <img class="objekt-img" [src]="thumb.thumbnailImage" alt="Thumbnail" style="max-width: 150px; max-height: 150px;"
        [matTooltip]="thumb.collectionId" aria-label="Button that displays a tooltip when focused or hovered over">
      <button class="pop-button" (click)="popHaveObjekt(posting.posting_id, thumb)" *ngIf="userId === posting.posting_userId && updateMode">
        <i class="fa-solid fa-x"></i>
      </button> 
    </div>
    <p>Want</p>
    <div class="objekt-container" *ngFor="let thumb of posting?.thumbnails?.want">
      <img class="objekt-img" [src]="thumb.thumbnailImage" alt="Thumbnail" style="max-width: 150px; max-height: 150px;"
        [matTooltip]="thumb.collectionId" aria-label="Button that displays a tooltip when focused or hovered over">
        <button class="pop-button" (click)="popWantObjekt(posting.posting_id, thumb)" *ngIf="userId === posting.posting_userId && updateMode">
          <i class="fa-solid fa-x"></i>
        </button>
    </div>
  </div>
  <div class="updateModeButton" *ngIf="userId === posting.posting_userId && updateMode">
    <button mat-menu-item (click)="updatePosting(posting.posting_id)">Update</button>
    <button mat-menu-item (click)="changeUpdateMode()">Cancel</button>
  </div>
</div>
}